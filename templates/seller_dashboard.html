{% extends "base.html" %}

{% block title %}Painel do Vendedor{% endblock %}

{% block content %}

{% block head %}
<style>
    .year p{
        cursor: pointer;
        font-weight: bold;
        margin: 5px 0;
        max-width: fit-content;
    }
    .months{
        display: none;
        margin-left: 20px;
    }
    .months p{
        max-width: fit-content;
        cursor: pointer;
        margin: 5px 0 5px 0;
    }
    .arrow_down{
        display: none;
    }
    .arrow_right{
        display: contents;
    }
</style>
{% endblock %}

<h1>Painel do Vendedor</h1>
<p>Nome: {{user_name}}</p>

<br>

<!-- Seleção de Ano e Mês -->
<div>
    {% set years = available_dates | map(attribute='year') | unique %}
    {% for y in years %}
    <div>
        <div class="year" onclick="toggleMonths('{{ y }}')">
            <p>
                <span class="arrow_right" style='font-size:15px;'>&#11208;</span>
                <span class="arrow_down" style='font-size:15px;'>&#11206;</span>
                 {{ y }}
            </p>
        </div>
        <div id="months-{{ y }}" class="months">
            {% for date in available_dates if date['year'] == y %}
            <p onclick="navigateTo('{{seller_id}}', '{{ y }}', '{{ date['month']|int }}')">
                {{ date['month']|int }} - {{ date['month']|int | month_name }}
            </p>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<p>Meta Geral: {{ general_goal | float | currency }}</p>
<p>Meta Individual: {{ individual_goal | float | currency }}</p>
<p>Faturamento Total da {{ user_branch[0] }} no Mês: {{ total_branch_sales | float | currency }}</p>
<p>Faturamento Atual no Mês: {{ total_seller_sales | float | currency }}</p>
<p>Percentual da Meta Individual Atingido: {{ individual_percentage | float | percentage}}</p>
<p>Percentual da Meta da {{ user_branch[0] }} Atingido: {{ branch_percentage | float | percentage}}</p>
<p>Comissão do Mês: {{ commission | float | currency }}</p>
{% if user_branch == 'Loja' %}
<p>Bônus do mês: {{ bonus | float | currency }}</p>
<p>Total: {{ extra_total | float | currency }}</p>
{% endif %}
<p><em>OBS: Os valores serão atualizados e não são definitivos.</em></p>

{% if user_role == 'master' %}
<a href="{{ url_for('dashboards.dashboard') }}">Voltar</a>
{% elif user_role == 'seller' %}
<a href="{{ url_for('users.logout') }}">Logout</a>
{% endif %}

<h2>Vendas do Mês</h2>
<table border="1">
    <tr>
        <th>Nº Pedido</th>
        <th>Data</th>
        <th>Valor</th>
        {% if user_role == 'master' %}
        <th>Deletar</th>
        {% endif %}
    </tr>
    {% for venda in vendas %}
    <tr>
        <td>{{ venda['order_number']  | float | int }}</td>
        <td>{{ venda['date'] }}</td>
        <td>{{ venda['amount'] | float | currency }}</td>
        {% if user_role == 'master' %}
        <td>
            <form action="{{ url_for('sales.delete_sale', sale_id=venda['id']) }}" method="post" style="display:inline;">
                <button type="submit" onclick="return confirm('Tem certeza que deseja deletar esta venda?');">x</button>
            </form>
        </td>
        {% endif %}
    </tr>
    {% endfor %}
</table>

{% if user_role == 'master' %}
<form action="{{ url_for('sales.delete_all_sales', seller_id=seller_id) }}" method="post">
    <button type="submit" onclick="return confirm('Tem certeza que deseja deletar todas as vendas deste vendedor?');">Remover Todas as Vendas</button>
</form>
{% endif %}


<script>
    function toggleMonths(year) {
        const months = document.getElementById('months-' + year);
        const arrowRight = months.previousElementSibling.querySelector('.arrow_right');
        const arrowDown = months.previousElementSibling.querySelector('.arrow_down');
        if (months.style.display === 'none' || months.style.display === '') {
            months.style.display = 'block';
            arrowRight.style.display = 'none';
            arrowDown.style.display = 'contents';
        } else {
            months.style.display = 'none';
            arrowRight.style.display = 'contents';
            arrowDown.style.display = 'none';
        }
    }

    function navigateTo(sellerId, year, month) {
        const url = `/dashboard/${sellerId}/${year}/${month}`;
        window.location.href = url;
    }

    // Adiciona um event listener para cada ano
    document.addEventListener('DOMContentLoaded', function() {
        const years = document.querySelectorAll('.year');
        years.forEach(year => {
            year.addEventListener('click', function() {
                const yearValue = this.textContent.trim();
                toggleMonths(yearValue);
            });
        });
    });
</script>

{% endblock %}